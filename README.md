# Установщик базы данных для BeeWebShop CMS

## Назначение репозитория

В репозитории находится автономный установщик, который подготавливает базу данных и записывает файл `config_db.php` с
настройками подключения. Скрипт предназначен для первоначального развёртывания BeeWebShop CMS и работает поверх
веб-сервера с PHP и MySQL.

> ⚠️  Основные SQL-скрипты содержатся в каталоге `install/stepsInsertDB`. Проверьте и при необходимости адаптируйте их
> под свою инфраструктуру **до запуска** установщика.

## Требования

* PHP 5.6+ с активированным расширением `mysqli`.
* Включённая директива `short_open_tag` (файл `config_db.php` создаётся с коротким тегом `<?`).
* Веб-сервер (Apache/Nginx) или встроенный PHP-сервер.
* MySQL 5.6+ (SQL-дамп создавался на версии 5.6.43).
* Права записи на файл `config_db.php` в корне проекта и на каталог `install/` во время установки.

## Структура проекта

```
./
├── README.md                # Текущее руководство
├── classes/class.db.php     # Класс-обёртка SafeMySQL, использующий config_db.php
├── config_db.php            # Шаблон конфигурации БД (перезаписывается установщиком)
└── install/
    ├── index.php            # Основной мастер установки (3 шага)
    ├── goInsertDB.php       # Запуск последовательности SQL-скриптов
    ├── stepsInsertDB/       # Шаги установки БД (PHP или SQL файлы)
    ├── step5.sql, step6.sql # Примеры SQL-дампов
    └── ...
```

## Подготовка

1. Создайте пустую базу данных MySQL и пользователя с правами `SELECT`, `INSERT`, `UPDATE`, `DELETE`, `CREATE`, `ALTER`
   и `DROP` в этой базе.
2. Скопируйте репозиторий в корень веб-сервера (установщик ожидает, что `config_db.php` будет находиться в
   `$_SERVER['DOCUMENT_ROOT']`).
3. Проверьте права на запись: веб-сервер должен иметь возможность перезаписать `config_db.php` и создавать файлы в
   каталоге `install/`.
4. При необходимости отредактируйте файлы в `install/stepsInsertDB/`:
   * В PHP-файлах (например, `step1.php`) хранятся SQL-дампы, присвоенные переменной `$QueryN`. Установщик выполнит
     содержимое переменной.
   * В SQL-файлах (`step5.sql`, `step6.sql`) размещены дополнительные запросы.
   * Заполнители `{[NAMECompany]}` и `{[CITYBINDTITLE]}` будут автоматически заменены значениями из формы шага 2.

## Запуск установщика

1. Запустите веб-сервер. Для локальной установки можно воспользоваться встроенным сервером PHP:
   ```bash
   php -S localhost:8000 -t /path/to/project
   ```
2. Откройте в браузере страницу `http://localhost:8000/install/index.php`.
3. Пройдите три шага мастера:
   * **Шаг 1. Подключение к базе данных** — укажите имя пользователя, пароль и имя базы данных. Скрипт проверит
     соединение и сохранит файл `config_db.php`.
   * **Шаг 2. Настройка сайта** — заполните данные организации (название, описание, город, телефон и т.п.). Эти данные
     используются для подстановки в SQL-скрипты и первичное наполнение таблиц.
   * **Шаг 3. Готово** — после успешного выполнения всех SQL-запросов появится отчёт по каждому шагу. По умолчанию
     создаются учётные данные администратора: логин `MainAdmin`, пароль `MainPassword`.
4. После успешного завершения **обязательно удалите каталог `/install`** с сервера.

## Повторный запуск и отладка

* Если нужно перезапустить установку, удалите созданные таблицы из базы и вручную верните `config_db.php` к исходному
  шаблону (можно взять его из `install/original_db_config.php`).
* Логи ошибок PHP можно смотреть в `install/error_log.txt` или в журнале веб-сервера.
* Скрипт `install/goInsertDB.php` последовательно читает файлы `step*.php` и `step*.sql`, выполняя их через
  `mysqli_multi_query`. При возникновении ошибки выполнение прерывается, а сообщение отображается во всплывающем окне
  мастера.

## Использование класса SafeMySQL

После установки приложение может пользоваться классом `classes/class.db.php`. Он автоматически подключает
`config_db.php` и предоставляет методы для безопасного выполнения запросов (плейсхолдеры `?s`, `?i`, `?a`, `?u`, `?p`).
Убедитесь, что файл `config_db.php` находится в корне веб-приложения и содержит актуальные параметры подключения.

## Безопасность

* Меняйте стандартные учётные записи администратора сразу после входа.
* Переносите установщик на продакшн-сервер только после настройки HTTPS и ограничения доступа к `/install/`.
* После удаления каталога `install/` убедитесь, что резервная копия SQL-дампа хранится в безопасном месте.

## Частые проблемы

| Симптом | Возможная причина | Решение |
| --- | --- | --- |
| Сообщение «Не удалось записать файл config_db.php» | Недостаточно прав на запись | Выдайте права на запись пользователю службы вебсервера (`chown/chmod`). |
| Ошибка подключения к базе данных | Неверные учётные данные или база недоступна | Убедитесь, что MySQL запущен и у пользователя есть доступ к базе. |
| Ошибки в шаге установки | Столкновение схемы БД или устаревшие SQL-запросы | Перепроверьте SQL-файлы и запустите установку в пустой базе. |

## Лицензирование и контакты

Исходные SQL-дампы и класс `SafeMySQL` предоставлены авторами проекта. Вопросы по коду направляйте команде, которая
сопровождает BeeWebShop CMS.
